# Generated from templates/source-repo/azure-pipelines.yml.njk. Do not edit directly.

pr: none

trigger:
  - main

# Using self-hosted 'Default' agent pool by default
# Change accordingly when using a different agent pool
# Can be deleted if self-hosted agents are not being used
# See https://learn.microsoft.com/en-us/azure/devops/pipelines/agents/agents
pool:
  name: rhtap-testing

container:
  image: quay.io/redhat-user-workloads/rhtap-shared-team-tenant/rhtap-task-runner@sha256:08e69dfad0be176e316d09b443e9039ac95bf3d6d5a84c0913b68fafb22149a1
  options: --privileged

# Using 'tssc' variable group by default
# Change accordingly when using a different variable group
# Can be deleted if the variables are set differently
# See https://learn.microsoft.com/en-us/azure/devops/pipelines/process/variables
variables:
  - group: backend-tests-dotnet-basic-txbafaik
  - name: CI_TYPE
    value: azure

steps:
  - bash: |
      echo "• init"
      bash /work/tssc/init.sh
    name: init
    env:
      ROX_API_TOKEN: $(ROX_API_TOKEN)
      # Uncomment this when using Bitbucket
      # GITOPS_AUTH_USERNAME: $(GITOPS_AUTH_USERNAME)
      GITOPS_AUTH_PASSWORD: $(GITOPS_AUTH_PASSWORD)
      # Set this password for your specific registry
      IMAGE_REGISTRY_PASSWORD: $(IMAGE_REGISTRY_PASSWORD)
      # QUAY_IO_CREDS_PSW: $(QUAY_IO_CREDS_PSW)
      # ARTIFACTORY_IO_CREDS_PSW: $(ARTIFACTORY_IO_CREDS_PSW)
      # NEXUS_IO_CREDS_PSW: $(NEXUS_IO_CREDS_PSW)
      COSIGN_SECRET_PASSWORD: $(COSIGN_SECRET_PASSWORD)
      COSIGN_SECRET_KEY: $(COSIGN_SECRET_KEY)
  - bash: |
      echo "• buildah-tssc"
      bash /work/tssc/buildah-tssc.sh
      echo "• cosign-sign-attest"
      bash /work/tssc/cosign-sign-attest.sh
    name: build
    env:
      ROX_API_TOKEN: $(ROX_API_TOKEN)
      # Uncomment this when using Bitbucket
      # GITOPS_AUTH_USERNAME: $(GITOPS_AUTH_USERNAME)
      GITOPS_AUTH_PASSWORD: $(GITOPS_AUTH_PASSWORD)
      # Set this password for your specific registry
      IMAGE_REGISTRY_PASSWORD: $(IMAGE_REGISTRY_PASSWORD)
      # QUAY_IO_CREDS_PSW: $(QUAY_IO_CREDS_PSW)
      # ARTIFACTORY_IO_CREDS_PSW: $(ARTIFACTORY_IO_CREDS_PSW)
      # NEXUS_IO_CREDS_PSW: $(NEXUS_IO_CREDS_PSW)
      COSIGN_SECRET_PASSWORD: $(COSIGN_SECRET_PASSWORD)
      COSIGN_SECRET_KEY: $(COSIGN_SECRET_KEY)
  - bash: |
      echo "• update-deployment"
      bash /work/tssc/update-deployment.sh
    name: deploy
    env:
      ROX_API_TOKEN: $(ROX_API_TOKEN)
      # Uncomment this when using Bitbucket
      # GITOPS_AUTH_USERNAME: $(GITOPS_AUTH_USERNAME)
      GITOPS_AUTH_PASSWORD: $(GITOPS_AUTH_PASSWORD)
      # Set this password for your specific registry
      IMAGE_REGISTRY_PASSWORD: $(IMAGE_REGISTRY_PASSWORD)
      # QUAY_IO_CREDS_PSW: $(QUAY_IO_CREDS_PSW)
      # ARTIFACTORY_IO_CREDS_PSW: $(ARTIFACTORY_IO_CREDS_PSW)
      # NEXUS_IO_CREDS_PSW: $(NEXUS_IO_CREDS_PSW)
      COSIGN_SECRET_PASSWORD: $(COSIGN_SECRET_PASSWORD)
      COSIGN_SECRET_KEY: $(COSIGN_SECRET_KEY)
  - bash: |
      echo "• acs-deploy-check"
      bash /work/tssc/acs-deploy-check.sh
      echo "• acs-image-check"
      bash /work/tssc/acs-image-check.sh
      echo "• acs-image-scan"
      bash /work/tssc/acs-image-scan.sh
    name: scan
    env:
      ROX_API_TOKEN: $(ROX_API_TOKEN)
      # Uncomment this when using Bitbucket
      # GITOPS_AUTH_USERNAME: $(GITOPS_AUTH_USERNAME)
      GITOPS_AUTH_PASSWORD: $(GITOPS_AUTH_PASSWORD)
      # Set this password for your specific registry
      IMAGE_REGISTRY_PASSWORD: $(IMAGE_REGISTRY_PASSWORD)
      # QUAY_IO_CREDS_PSW: $(QUAY_IO_CREDS_PSW)
      # ARTIFACTORY_IO_CREDS_PSW: $(ARTIFACTORY_IO_CREDS_PSW)
      # NEXUS_IO_CREDS_PSW: $(NEXUS_IO_CREDS_PSW)
      COSIGN_SECRET_PASSWORD: $(COSIGN_SECRET_PASSWORD)
      COSIGN_SECRET_KEY: $(COSIGN_SECRET_KEY)
  - bash: |
      echo "• show-sbom-rhdh"
      bash /work/tssc/show-sbom-rhdh.sh
      echo "• summary"
      bash /work/tssc/summary.sh
    name: summary
    env:
      ROX_API_TOKEN: $(ROX_API_TOKEN)
      # Uncomment this when using Bitbucket
      # GITOPS_AUTH_USERNAME: $(GITOPS_AUTH_USERNAME)
      GITOPS_AUTH_PASSWORD: $(GITOPS_AUTH_PASSWORD)
      # Set this password for your specific registry
      IMAGE_REGISTRY_PASSWORD: $(IMAGE_REGISTRY_PASSWORD)
      # QUAY_IO_CREDS_PSW: $(QUAY_IO_CREDS_PSW)
      # ARTIFACTORY_IO_CREDS_PSW: $(ARTIFACTORY_IO_CREDS_PSW)
      # NEXUS_IO_CREDS_PSW: $(NEXUS_IO_CREDS_PSW)
      COSIGN_SECRET_PASSWORD: $(COSIGN_SECRET_PASSWORD)
      COSIGN_SECRET_KEY: $(COSIGN_SECRET_KEY)
  - bash: |
      echo "• cleanup agent storage"
      echo "Disk usage before cleanup:"
      df -h
      echo "Current Directory:"
      pwd
      echo "Cleaning directory: $(Agent.WorkFolder)"
      echo "Moving to Home dir: $(Agent.HomeDirectory)"
      cd $(Agent.HomeDirectory)
      # rm -rf $(Agent.WorkFolder)/*
      echo "Running Docker prune targeting images older than 12h"
      podman system prune -af --filter "until=12h"
      echo "Disk usage after cleanup:"
      df -h
    name: cleanup
    condition: always()